<!DOCTYPE html>
<html>

<head>
  <title>COGIP Dashboard</title>
  <link rel="shortcut icon" href="#" />
  <link rel="stylesheet" href="{{ url_for('static', path='css/prod/output.css') }}" />
</head>

<body class="flex flex-col h-full w-full bg-zinc-900 overflow-hidden">
  <div class="flex flex-row">
    <div class="w-1/4 text-center h-minus-footer pt-2.5 pr-1 pl-2.5 border-r border-grey-color" id="menu">
      <img src="static/img/cogip-logo.png" class="mx-auto h-10p py-2.5" />
      <div id="nav-tool">
        ...
      </div>
    </div>
    <div class="w-3/4">
      <button
        class="relative z-10 mt-3 px-4 py-2 rounded-lg border border-gray-800 bg-gray-300 bg-opacity-30 hover:bg-zinc-800 hover:opacity-70 float-end z-60"
        id="buttonRefresh" type="button" onclick="location.reload();">
        <img src="{{ url_for('static', path='img/refresh.svg') }}" />
      </button>
      <canvas id="board" class="mt-2.5 absolute bg-contain"
        style="background-image: url(../static/img/ground2024.png)"></canvas>
      <button
        class="relative z-10 mt-3 px-4 py-2 rounded-lg border border-gray-800 hover:bg-zinc-800 hover:opacity-70 float-end"
        id="buttonCameraModal" type="button" onclick="modalCamera()" data-bs-toggle="modal"
        data-bs-target="#cameraModal">
        <img src="{{ url_for('static', path='img/camera.svg') }}" />
      </button>
    </div>
  </div>

  <footer class="mt-auto bg-zinc-900 text-grey-color mx-2">
    <div class="container-lg pt-2">
      <span class="text-muted float-left" id="connection">
        <pre
          class="text-grey-color text-sm inline"><img class="mr-5 w-[20px] inline" src="{{ url_for('static', path='img/cross_red_circle.svg') }}" /></pre>
      </span>
      <span class="text-muted float-right inline" id="state">
        <pre class="text-grey-color text-sm inline" id="state_robot"></pre>
      </span>
    </div>
  </footer>

  <div id="cameraModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
    <div class="bg-zinc-900 rounded-lg shadow-lg max-w-4xl w-full">
      <div class="p-4 m-auto relative" id="displayFlux">
        <button type="button"
          class="absolute top-4 right-4 bg-transparent text-grey-color text-2xl leading-none hover:text-gray-400 focus:outline-none"
          aria-label="Close" onclick="closeModal('cameraModal')">&times;</button>
      </div>
    </div>
  </div>


  <div id="wizardModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
    <div id="wizardModalContent" class="bg-zinc-900 rounded-lg shadow-lg w-full max-w-lg">
      <div id="modalHeader" class="border-b border-gray-700 p-2">
        <h5 class="text-lg font-medium text-grey-color" id="wizardModalTitle"></h5>
      </div>
      <div id="modalBody" class="m-4 text-center">
        <span class="block text-lg font-medium text-grey-color" id="wizardName"></span>
        <input id="wizardInput" type="text" placeholder="" />
      </div>
      <div class="border-t border-gray-700 p-4 flex justify-end">
        <button id="btnSendWizard" type="button"
          class="bg-red-cogip border-red-cogip text-grey-color font-medium py-2 px-4 rounded-md">
          Send
        </button>
      </div>
    </div>
  </div>

  <div class="fixed inset-0 z-50 hidden" id="scoreModal">
    <div class="flex h-full w-full p-4 text-center">
      <div class="w-full p-6 mx-auto bg-zinc-900 rounded-lg shadow-lg">
        <div class="flex items-center justify-between pb-4 border-b border-gray-600">
          <h5 class="text-lg font-medium text-grey-color">Score</h5>
          <button type="button" class="text-grey-color text-2xl leading-none hover:text-gray-400" aria-label="Close"
            onclick="closeModal('scoreModal')">&times;</button>
        </div>
        <div class="flex h-full items-center justify-center align-middle">
          <div class="align-middle text-grey-color text-1500p">
            <p class="m-auto" id="displayScore"></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="text/javascript" src="{{ url_for('static', path='js/external/socket.io.min.js') }}"></script>

  <script type="module">
    import * as socketModule from "../static/js/socketModule.js";
    import * as drawModule from "../static/js/drawModule.js";
    import * as cameraModule from "../static/js/cameraModule.js";
    import * as wizardModule from "../static/js/wizardModule.js";
    import * as scoreModule from "../static/js/scoreModule.js";
    import { virtualKeyboard } from "../static/js/keyboardModule.js";

    window.addEventListener("resize", drawModule.resizeCanvas, false);

    document.addEventListener("DOMContentLoaded", function (event) {
      drawModule.resizeCanvas(); // draw background
      virtualKeyboard.init(); // initialize keyboard

      const socketioPort = parseInt(window.location.port) + 10

      io.connect(`:${socketioPort}/dashboard`)
        .on("connect", function () {
          socketModule.onConnection(this);
        })
        .on("disconnect", function () {
          socketModule.onDisconnect();
        })
        .on("tool_menu", function (menu) {
          socketModule.onMenu(menu, "tool", this);
          virtualKeyboard._actualize();
        })
        .on("pose_current", function (robot_id, msg) {
          drawModule.updatePoseCurrent(robot_id, msg);
        })
        .on("pose_order", function (robot_id, msg) {
          drawModule.updatePoseOrder(robot_id, msg);
        })
        .on("obstacles", function (msg) {
          drawModule.updateObstacles(msg);
        })
        .on("state", function (robot_id, msg) {
          drawModule.displayMsg(msg); // uses message to display information in bottom page
          drawModule.drawBoardElement(msg); // move robot
        })
        .on("path", function (robot_id, msg) {
          drawModule.recordPath(msg);
        })
        .on("wizard", function (msg) {
          wizardModule.openWizardModal(msg, this);
          virtualKeyboard._actualize();
        })
        .on("close_wizard", function () {
          document
            .getElementById("wizardModal")
            .setAttribute("style", "display: none;");
          virtualKeyboard.close();
        })
        .on("score", function (score) {
          scoreModule.openScoreModal(score);
        })
        .on("close_score", function () {
          document
            .getElementById("scoreModal")
            .setAttribute("style", "display: none;");
        });
    });
  </script>
</body>

</html>